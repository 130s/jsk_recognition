<launch>
  <arg name="INPUT" default="/tilt_scan" />
  <arg name="BASE_FRAME_ID" default="base_footprint" />
  <group ns="tilt_multi_plane_detection">
    <node name="tilt_scan_to_cloud"
          pkg="laser_filters" type="scan_to_cloud_filter_chain">
      <remap from="scan" to="$(arg INPUT)" />
      <rosparam>
        scan_filter_chain:
        - name: shadows
          type: ScanShadowsFilter
          params:
            min_angle: 0
            max_angle: 170
            neighbors: 5
            window: 1
        - name: dark_shadows
          type: LaserScanIntensityFilter
          params: 
            lower_threshold: 100
            upper_threshold: 10000
            disp_histogram: 0
      </rosparam>
    </node>
    <node pkg="nodelet" type="nodelet" name="tilt_laser_manager"
          args="manager" output="screen" />
    <node name="xfilter" pkg="nodelet" type="nodelet"
          args="load pcl/PassThrough tilt_laser_manager"
          output="screen" clear_params="true">
      <remap from="~input" to="cloud_filtered" />
      <rosparam>
        filter_field_name: x
        filter_limit_min: 0.3
        filter_limit_max: 5.0
      </rosparam>
    </node>

    <node name="transform_cloud" pkg="nodelet" type="nodelet"
          args="load jsk_pcl/TfTransformCloud tilt_laser_manager">
      <remap from="~input" to="xfilter/output" />
      <param name="target_frame_id" value="$(arg BASE_FRAME_ID)" />
    </node>
    <node name="euclidean_clustering"
          pkg="nodelet" type="nodelet"
          args="load jsk_pcl/EuclideanClustering tilt_laser_manager"
          output="screen">
      <remap from="~input" to="transform_cloud/output" />
    </node>
    <node pkg="nodelet" type="nodelet"
          name="euclidean_clustering_decomposer"
          args="load jsk_pcl/ClusterPointIndicesDecomposerZAxis tilt_laser_manager"
          output="screen">
      <remap from="~input" to="transform_cloud/output" />
      <remap from="~target" to="euclidean_clustering/output" />
      <rosparam>
        publish_clouds: false
        publish_tf: false
      </rosparam>
    </node>
    <node pkg="nodelet" type="nodelet"
          name="line_segment_detector"
          args="load jsk_pcl/LineSegmentDetector tilt_laser_manager"
          output="screen">
      <remap from="~input" to="transform_cloud/output" />
      <remap from="~input_indices" to="euclidean_clustering/output" />
    </node>
    <node pkg="nodelet" type="nodelet"
          name="line_segment_decomposer"
          args="load jsk_pcl/ClusterPointIndicesDecomposerZAxis tilt_laser_manager"
          output="screen">
      <remap from="~input" to="transform_cloud/output" />
      <remap from="~target" to="line_segment_detector/output/inliers" />
      <rosparam>
        publish_clouds: false
        publish_tf: false
      </rosparam>
    </node>
    <node pkg="nodelet" type="nodelet"
          name="line_segment_collector"
          args="load jsk_pcl/LineSegmentCollector tilt_laser_manager"
          output="screen">
      <remap from="~input" to="transform_cloud/output" />
      <remap from="~input_indices" to="line_segment_detector/output/inliers" />
      <remap from="~input_coefficients" to="line_segment_detector/output/coefficients" />
      <remap from="~input_joint_states" to="/joint_states" />
      <rosparam>
        fixed_frame_id: base_footprint
        rotate_joint_name: laser_tilt_mount_joint
      </rosparam>
    </node>
    <node pkg="nodelet" type="nodelet"
          name="connected_segment"
          args="load jsk_pcl/ClusterPointIndicesDecomposerZAxis tilt_laser_manager"
          output="screen">
      <remap from="~input" to="line_segment_collector/output/cloud" />
      <remap from="~target" to="line_segment_collector/debug/connect_segments/inliers" />
      <rosparam>
        publish_clouds: false
        publish_tf: false
      </rosparam>
    </node>
    <node pkg="nodelet" type="nodelet"
          name="multi_plane_decomposer"
          args="load jsk_pcl/ClusterPointIndicesDecomposerZAxis tilt_laser_manager"
          output="screen">
      <remap from="~input" to="line_segment_collector/output/cloud" />
      <remap from="~target" to="line_segment_collector/output/inliers" />
      <rosparam>
        publish_clouds: false
        publish_tf: false
      </rosparam>
    </node>
  </group>
</launch>
